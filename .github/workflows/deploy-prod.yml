name: deploy-prod

on:
    push:
        branches:
            - feature/cicd
        # tags:
        #     - 'v*'
    workflow_dispatch:

jobs:
    build-and-copy:
        runs-on: ubuntu-latest
        if: always()
        steps:
          - name: checkout
            uses: actions/checkout@v4

          - name: Setup PNPM
            uses: pnpm/action-setup@v3
            with:
                version: 10
                run_install: false

          - name: Setup Node.js
            uses: actions/setup-node@v4
            with:
                node-version: '24.11.1' 
                cache: 'pnpm'
        
          - name: vars
            id: vars
            run: |
                sha_short=$(git rev-parse --short HEAD)
                sed -i "s/\"version\": \".*\"/\"version\": \"$sha_short\"/" package.json
                echo "NEXT_PUBLIC_API_BASE_URL=https://trend-api.votebox.kr" > .env
                pnpm install --frozen-lockfile
                pnpm build
          
        
          - name: scp-to-ec2
            uses: appleboy/scp-action@master
            with: 
                host: ${{ secrets.EC2_HOST }}
                username: ${{ secrets.EC2_USER }}
                key: ${{ secrets.EC2_SSH_KEY }}
                source: '*'
                target: ${{ secrets.EC2_FRONT_PATH }}
                rm: true

          - name: start service
            uses: appleboy/ssh-action@master
            with: 
                host: ${{ secrets.EC2_HOST }}
                username: ${{ secrets.EC2_USER }}
                key: ${{ secrets.EC2_SSH_KEY }}
                script: |
                    export NVM_DIR=~/.nvm
                    source ~/.nvm/nvm.sh
                    cd ${{ secrets.EC2_FRONT_PATH }}
                    pm2 start server.js --name trend-web || pm2 restart trend-web
                    pm2 save

